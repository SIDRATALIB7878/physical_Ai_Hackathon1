# Data Model: Book Content Embeddings Pipeline

**Feature**: 002-book-embeddings-qdrant
**Date**: 2025-12-19
**Status**: Draft

## Entities

### Book Page
- **Description**: Represents an individual page of book content with properties like URL, raw HTML content, extracted text, and structural elements
- **Fields**:
  - `id` (string): Unique identifier for the page
  - `url` (string): The URL where the page is accessible
  - `title` (string): The title of the page
  - `raw_html` (string): The original HTML content of the page (optional, for debugging)
  - `extracted_text` (string): Clean text extracted from the HTML
  - `headings` (list of strings): Headings from the page
  - `created_at` (datetime): When the page record was created
  - `updated_at` (datetime): When the page record was last updated

### Text Chunk
- **Description**: A segment of text from a book page that will be converted into an embedding
- **Fields**:
  - `id` (string): Unique identifier for the chunk
  - `page_id` (string): Reference to the parent Book Page
  - `content` (string): The text content of the chunk
  - `start_pos` (integer): Start position in the original page text
  - `end_pos` (integer): End position in the original page text
  - `chunk_index` (integer): Sequential index of this chunk within the page
  - `tokens_count` (integer): Number of tokens in this chunk

### Embedding
- **Description**: A vector representation of text content generated by the Cohere model, associated with its source page and metadata
- **Fields**:
  - `id` (string): Unique identifier for the embedding
  - `chunk_id` (string): Reference to the source Text Chunk
  - `vector` (list of floats): The embedding vector (length depends on model)
  - `model_name` (string): Name of the model used to generate the embedding
  - `created_at` (datetime): When the embedding was generated

### Metadata
- **Description**: Information that accompanies each embedding, including the original page URL, section headings, and other contextual information
- **Fields**:
  - `id` (string): Unique identifier for the metadata
  - `embedding_id` (string): Reference to the associated Embedding
  - `page_url` (string): URL of the original book page
  - `page_title` (string): Title of the original book page
  - `section_heading` (string): The heading under which this content appears
  - `book_id` (string): Identifier for the book this content belongs to
  - `page_number` (integer): Page number in the book (if applicable)
  - `additional_tags` (list of strings): Additional tags for categorization

### Pipeline Job
- **Description**: Represents a single execution of the embedding pipeline
- **Fields**:
  - `id` (string): Unique identifier for the job
  - `book_url` (string): Root URL or identifier for the book being processed
  - `status` (enum): Current status (QUEUED, PROCESSING, COMPLETED, FAILED)
  - `pages_count` (integer): Number of pages to process
  - `pages_processed` (integer): Number of pages processed so far
  - `pages_failed` (integer): Number of pages that failed to process
  - `created_at` (datetime): When the job was created
  - `started_at` (datetime): When the job started processing
  - `completed_at` (datetime): When the job completed (if finished)
  - `error_message` (string): Error message if the job failed

## Relationships

- Book Page 1 --- * Text Chunk (One page can have multiple text chunks)
- Text Chunk 1 --- 1 Embedding (One chunk generates one embedding)
- Embedding 1 --- 1 Metadata (One embedding has one metadata record)
- Pipeline Job 1 --- * Book Page (One job processes many pages)

## Validation Rules

- Book Page:
  - URL must be a valid URL format
  - Extracted text must not be empty
  - Created_at must be set on creation

- Text Chunk:
  - Content must not be empty
  - Start position must be less than end position
  - Tokens count must be positive and within model limits

- Embedding:
  - Vector must have the correct length for the specified model
  - Model name must be one of the supported models
  - Must reference a valid Text Chunk

- Metadata:
  - Page URL must be a valid URL
  - Book ID must be provided
  - Must reference a valid Embedding